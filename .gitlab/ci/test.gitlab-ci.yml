.install_debs: &install_debs
    - DEBIAN_FRONTEND=noninteractive SUDO_FORCE_REMOVE=yes apt --assume-yes -o Dpkg::Options::="--force-confold" --allow-downgrades install ${CI_PROJECT_DIR}/*.deb

.test-stage:
  stage: test
  image: "core-tests"
  variables:
    PYTEST_ADDOPTS: "--color=yes"
  before_script:
    - *install_debs
  cache:
    paths: 
      - src/tests/apps
    key: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
  needs:
      - job: build-yunohost
        artifacts: true
      - job: build-ssowat
        artifacts: true
      - job: build-moulinette
        artifacts: true
      - job: upgrade
  artifacts:
    paths:
      - ./.coverage

########################################
# TESTS
########################################

test-helpers2:
  extends: .test-stage
  script:
    - cd tests
    - bash test_helpers.sh

test-helpers2.1:
  extends: .test-stage
  script:
    - cd tests
    - bash test_helpers.sh 2.1

test-domains:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_domains.py --cov=src

test-dns:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_dns.py --cov=src

test-apps:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_apps.py --cov=src

test-appscatalog:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_app_catalog.py --cov=src

test-appurl:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_appurl.py --cov=src

test-questions:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_questions.py --cov=src

test-app-config:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_app_config.py --cov=src

test-app-resources:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_app_resources.py --cov=src

test-changeurl:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_changeurl.py --cov=src

test-backuprestore:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_backuprestore.py --cov=src

test-permission:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_permission.py --cov=src

test-settings:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_settings.py --cov=src

test-user-group:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_user-group.py --cov=src

test-regenconf:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_regenconf.py --cov=src

test-service:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_service.py --cov=src

test-ldapauth:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_ldapauth.py --cov=src

test-sso-and-portalapi:
  extends: .test-stage
  script:
    - python3 -m pytest src/tests/test_sso_and_portalapi.py --cov=src
